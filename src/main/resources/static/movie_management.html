<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Management - MovieSphere</title>
</head>
<body>
<!-- Header -->
<header>
    <div>
        <a href="admin.html">MovieSphere</a>
        <nav>
            <ul>
                <li><a href="admin.html">Dashboard</a></li>
                <li><a href="movie_management.html">Movies</a></li>
                <li><a href="user_management.html">Users</a></li>
            </ul>
        </nav>
    </div>
</header>

<div>
    <div>
        <h1>Movie Management</h1>
        <button id="addMovieBtn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            Add Movie
        </button>
    </div>

    <div id="loading">
        <div></div>
        <p>Loading movies...</p>
    </div>

    <div id="moviesTable" hidden>
        <div>
            <div>
                <h2>Movies</h2>
                <div>Total: <span id="movieCount">0</span></div>
            </div>
            <div>
                <table>
                    <thead>
                    <tr>
                        <th>Poster</th>
                        <th>Title</th>
                        <th>Genre</th>
                        <th>Release Date</th>
                        <th>Rating</th>
                        <th>Available</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="moviesTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div>
            <div>
                <h2>Rentals</h2>
                <div>Total: <span id="rentalCount">0</span></div>
            </div>
            <div>
                <table>
                    <thead>
                    <tr>
                        <th>Movie Title</th>
                        <th>Rented By</th>
                        <th>Rental Date</th>
                    </tr>
                    </thead>
                    <tbody id="rentalsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Movie Modal -->
<div id="movieModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md">
        <h3 class="text-xl font-bold mb-4">Add/Edit Movie</h3>
        <form id="movieForm">
            <input type="hidden" id="movieId">
            <div class="mb-4">
                <label class="block font-medium mb-2" for="title">Title</label>
                <input type="text" id="title" class="w-full" required>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-2" for="genre">Genre</label>
                <input type="text" id="genre" class="w-full" required>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-2" for="releaseDate">Release Date</label>
                <input type="date" id="releaseDate" class="w-full" required>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-2" for="description">Description</label>
                <textarea id="description" class="w-full" rows="3" required></textarea>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-2" for="rating">Rating (0-10)</label>
                <input type="number" id="rating" step="0.1" min="0" max="10" class="w-full" required>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-2" for="imageUrl">Poster URL</label>
                <input type="url" id="imageUrl" class="w-full" placeholder="https://example.com/poster.jpg">
            </div>
            <div class="mb-4 flex items-center">
                <input type="checkbox" id="available" class="mr-2">
                <label for="available" class="font-medium">Available for Rent</label>
            </div>
            <div class="flex justify-end">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2">
                    Save Movie
                </button>
                <button type="button" id="cancelBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const apiUrl = '/api/movies';

    document.addEventListener('DOMContentLoaded', () => {
        fetchMovies();
        fetchRentals();
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('addMovieBtn').addEventListener('click', openAddMovieModal);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        document.getElementById('movieForm').addEventListener('submit', handleFormSubmit);
    }

    async function fetchMovies() {
        try {
            const response = await fetch(apiUrl);
            const movies = await response.json();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('moviesTable').classList.remove('hidden');
            renderMovies(movies);
        } catch (error) {
            console.error('Error fetching movies:', error);
        }
    }

    async function fetchRentals() {
        try {
            const response = await fetch(`${apiUrl}/rentals`);
            const rentals = await response.json();
            renderRentals(rentals);
        } catch (error) {
            console.error('Error fetching rentals:', error);
        }
    }

    function renderMovies(movies) {
        const tbody = document.getElementById('moviesTableBody');
        tbody.innerHTML = '';

        // Update movie count
        document.getElementById('movieCount').textContent = movies.length;

        movies.forEach(movie => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-700 transition-colors duration-200';
            tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${movie.imageUrl ? 
                            `<img src="${movie.imageUrl}" alt="${movie.title}" class="h-20 w-14 object-cover rounded shadow-md">` : 
                            '<div class="h-20 w-14 bg-gray-700 flex items-center justify-center rounded shadow-md"><span class="text-xs text-gray-400">No Image</span></div>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${movie.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${movie.genre || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${movie.releaseDate ? new Date(movie.releaseDate).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${movie.rating >= 7 ? 'bg-green-500 bg-opacity-20 text-green-400' : movie.rating >= 5 ? 'bg-yellow-500 bg-opacity-20 text-yellow-400' : 'bg-red-500 bg-opacity-20 text-red-400'}">
                            ${movie.rating}/10
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${movie.available ? 'bg-green-500 bg-opacity-20 text-green-400' : 'bg-red-500 bg-opacity-20 text-red-400'}">
                            ${movie.available ? 'Available' : 'Unavailable'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="openEditMovieModal(${movie.id})" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded mr-2 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                            Edit
                        </button>
                        <button onclick="deleteMovie(${movie.id})" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            Delete
                        </button>
                    </td>
                `;
            tbody.appendChild(tr);
        });
    }

    async function renderRentals(rentals) {
        const tbody = document.getElementById('rentalsTableBody');
        tbody.innerHTML = '';

        // Update rental count
        document.getElementById('rentalCount').textContent = rentals.length;

        for (const rental of rentals) {
            const [movieId, userName] = rental.split(',');
            const movie = await getMovieById(movieId);
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-700 transition-colors duration-200';

            // Get current date for demo purposes (in a real app, this would come from the rental data)
            const rentalDate = new Date().toLocaleDateString();

            tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${movie ? movie.title : 'Unknown'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${userName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-400">${rentalDate}</td>
                `;
            tbody.appendChild(tr);
        }
    }

    async function getMovieById(id) {
        try {
            const response = await fetch(`${apiUrl}/${id}`);
            return response.ok ? await response.json() : null;
        } catch (error) {
            console.error('Error fetching movie:', error);
            return null;
        }
    }

    function openAddMovieModal() {
        document.getElementById('movieForm').reset();
        document.getElementById('movieId').value = '';
        document.getElementById('movieModal').classList.remove('hidden');
    }

    async function openEditMovieModal(id) {
        try {
            const movie = await getMovieById(id);
            if (movie) {
                document.getElementById('movieId').value = movie.id;
                document.getElementById('title').value = movie.title;
                document.getElementById('genre').value = movie.genre;
                document.getElementById('releaseDate').value = movie.releaseDate;
                document.getElementById('description').value = movie.description;
                document.getElementById('rating').value = movie.rating;
                document.getElementById('imageUrl').value = movie.imageUrl || '';
                document.getElementById('available').checked = movie.available;
                document.getElementById('movieModal').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error fetching movie for edit:', error);
        }
    }

    function closeModal() {
        document.getElementById('movieModal').classList.add('hidden');
    }

    async function handleFormSubmit(event) {
        event.preventDefault();
        const id = document.getElementById('movieId').value;
        const movie = {
            title: document.getElementById('title').value,
            genre: document.getElementById('genre').value,
            releaseDate: document.getElementById('releaseDate').value,
            description: document.getElementById('description').value,
            rating: parseFloat(document.getElementById('rating').value),
            imageUrl: document.getElementById('imageUrl').value || null,
            available: document.getElementById('available').checked
        };

        try {
            const url = id ? `${apiUrl}/${id}` : apiUrl;
            const method = id ? 'PUT' : 'POST';
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(movie)
            });
            if (response.ok) {
                closeModal();
                fetchMovies();
            } else {
                console.error('Error saving movie:', await response.text());
            }
        } catch (error) {
            console.error('Error saving movie:', error);
        }
    }

    async function deleteMovie(id) {
        if (confirm('Are you sure you want to delete this movie?')) {
            try {
                const response = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    fetchMovies();
                } else {
                    console.error('Error deleting movie:', await response.text());
                }
            } catch (error) {
                console.error('Error deleting movie:', error);
            }
        }
    }
</script>
</body>
</html>
